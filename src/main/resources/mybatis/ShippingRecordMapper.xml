<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.ShippingRecordMapper">

	<select id="selectAllByEmployeeId" parameterType="int" resultType="ShippingRecord">
		SELECT * FROM shipping_records
		WHERE employee_id = #{employeeId}
		AND shipping_requested_at IS NOT NULL
		AND returned_at IS NULL
		ORDER BY shipping_requested_at DESC
	</select>

	<select id="selectAllIsShippingRequest" resultType="ShippingRecord">
		SELECT * FROM shipping_records
		WHERE shipping_requested_at IS NOT NULL
		AND shipped_at IS NULL
		AND returned_at IS NULL
		ORDER BY shipping_requested_at DESC
	</select>
	
<!--	s-->
	
	<select id="selectAllIsShipped" resultType="ShippingRecord">
		SELECT * FROM shipping_records
		WHERE shipping_requested_at IS NOT NULL
		AND shipped_at IS NOT NULL
		AND returned_at IS NULL
		ORDER BY shipped_at DESC
	</select>

	<select id="selectById" parameterType="int" resultType="ShippingRecord">
		SELECT * FROM shipping_records
		WHERE id = #{id}
	</select>

	<select id="selectByEmployeeId" parameterType="int" resultType="ShippingRecord">
		SELECT * FROM shipping_records
		WHERE employee_id = #{employeeId}
		AND shipping_delete_at IS NULL
		AND shipping_requested_at IS NULL
		AND shipped_at IS NULL
		AND returned_at IS NULL
		ORDER BY id DESC
        LIMIT 0, 1
	</select>

	<update id="setDeleteById" parameterType="int">
		UPDATE shipping_records SET shipping_delete_at = NOW()
		WHERE id = #{id}
	</update>

	<insert id="insert" parameterType="ShippingRecord">
		INSERT INTO shipping_records (recipient_name, recipient_post_code, recipient_address, recipient_phone,
			sender_name, sender_post_code, sender_address, sender_phone,
			shipping_method, ship_date, arrival_date, shipping_number,note,
			employee_id, shipping_add_at)
		VALUES (#{recipientName}, #{recipientPostCode}, #{recipientAddress}, #{recipientPhone},
			#{senderName}, #{senderPostCode}, #{senderAddress}, #{senderPhone},
			#{shippingMethod}, #{shipDate}, #{arrivalDate}, #{shippingNumber}, #{note},
			#{employeeId}, NOW())
	</insert>

	<update id="update" parameterType="ShippingRecord">
		UPDATE shipping_records
		SET recipient_name = #{recipientName}, recipient_post_code = #{recipientPostCode}, recipient_address = #{recipientAddress}, recipient_phone = #{recipientPhone},
			sender_name = #{senderName}, sender_post_code = #{senderPostCode}, sender_address = #{senderAddress}, sender_phone = #{senderPhone},
			shipping_method = #{shippingMethod}, ship_date = #{shipDate}, arrival_date = #{arrivalDate}, shipping_number = #{shippingNumber}, note = #{note}
		WHERE id = #{id}
		AND shipping_requested_at IS NULL
		AND shipped_at IS NULL
		AND returned_at IS NULL
	</update>
	
	<update id="addShippingRequest" parameterType="int">
		UPDATE shipping_records
		SET shipping_requested_at = NOW()
		WHERE id = #{id}
		AND shipping_requested_at IS NULL
		AND shipped_at IS NULL
		AND returned_at IS NULL
	</update>
	
	<update id="addShipped" parameterType="int">
		UPDATE shipping_records
		SET shipped_at = NOW()
		WHERE id = #{id}
		AND shipping_requested_at IS NOT NULL
		AND shipped_at IS NULL
		AND returned_at IS NULL
	</update>
	
	<update id="addReturned" parameterType="int">
		UPDATE shipping_records
		SET returned_at = NOW()
		WHERE id = #{id}
		AND shipping_requested_at IS NOT NULL
		AND shipped_at IS NOT NULL
		AND returned_at IS NULL
	</update>
	
	<select id="countActive" resultType="long">
		SELECT COUNT(*) FROM shipping_records
		WHERE returned_at IS NULL
		AND shipping_requested_at IS NOT NULL
		AND shipped_at IS NOT NULL
	</select>
	
	<select id="selectLimitedIsShipped" resultType="ShippingRecord">
		SELECT * FROM shipping_records
		WHERE shipping_requested_at IS NOT NULL
		AND shipped_at IS NOT NULL
		AND returned_at IS NULL
		ORDER BY shipped_at DESC
		LIMIT #{offset}, #{num}
	</select>

</mapper>
